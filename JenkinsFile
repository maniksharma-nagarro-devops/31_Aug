pipeline {
    agent any
    
    
    stages {
	   
        stage("Code Build Using Maven"){
            steps{
            		withMaven(maven:'maven2'){
			sh 'mvn -f pom.xml install'
		}
            }
        }
	stage('SonarQube Analysis'){
	        steps{
	            withSonarQubeEnv('sonar'){
	                sh 'mvn clean install sonar:sonar -Dsonar.projectKey=Manik_Project -Dsonar.host.url=http://54.166.40.11:9000'
	      //      sh 'mvn clean install sonar:sonar -Dsonar.projectKey=Pipeline-jenkins -Dsonar.projectName=assignemnt'

	            
	        }
	        }
	}


	stage('Deploy to artifactory'){
		   steps{
		        rtUpload(
		            serverId: "artifactory-server",
		            spec: '''{
		                    "files":[
		                    {
		                        "pattern":"*.war",
		                        "target":"assignment_dev"
		                     }
		                             ]
		            }'''
		        )
		   }
		}





        stage('Creating Docker Images') {
            steps{
                sh 'docker build -t manik_images_dev:latest .'
            }
        }

 
	stage('Check and Delete Existing Container'){
	    steps{
			sh "chmod +x -R ${env.WORKSPACE}"
			sh "./container_check.sh"
			}
		}


	stage('Run docker image'){
	    steps{
			sh 'docker run --name dev -d -p 9080:8080 manik_images_dev:latest'
			}
		}
    }

}
